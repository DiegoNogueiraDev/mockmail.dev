#######################################################################
# /etc/haproxy/haproxy.cfg – v2 domínios (api.mockmail.dev + n8n.cortexflow.space)
# Última edição : 11 jun 2025
#######################################################################

############################
# ▶ GLOBAL
############################
global
    log /dev/log local0 info
    log /dev/log local1 notice
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin
    stats timeout 30s
    user  haproxy
    group haproxy
    daemon

    # Proteção contra ataques DDoS
    maxconn 4096                      # nº máx. de conexões simultâneas

############################
# ▶ DEFAULTS
############################
defaults
    log     global
    mode    http
    option  httplog
    timeout connect 5s
    timeout client  50s
    timeout server  50s
    maxconn 5000

    # Health-check & redispatch
    retries 3
    option  redispatch

############################
# ▶ FRONTENDS
############################

# ── HTTP :80 ➜ redireciona para HTTPS
frontend http_in
    bind *:80
    mode http
    # ACME challenge exception
    acl is_acme_challenge path_beg /.well-known/acme-challenge/
    use_backend backend_webroot if is_acme_challenge
    # Redirect to HTTPS except for ACME challenges
    redirect scheme https code 301 if !{ ssl_fc } !is_acme_challenge

# ── HTTPS :443 com SNI
# Lê todos os .pem em /etc/ssl/haproxy/ e devolve o cert correto
frontend https_in
    bind *:443 ssl crt /etc/ssl/haproxy/ no-sslv3 no-tlsv10 no-tlsv11
    mode http

    # ACLs por domínio
    acl host_api_mockmail  hdr(host) -i api.mockmail.dev
    acl host_n8n           hdr(host) -i n8n.cortexflow.space
    acl host_watch_mockmail hdr(host) -i watch.mockmail.dev
    acl is_acme_challenge path_beg /.well-known/acme-challenge/

    use_backend backend_webroot if is_acme_challenge
    use_backend backend_mockmail if host_api_mockmail
    use_backend backend_n8n       if host_n8n
    use_backend backend_watch_mockmail if host_watch_mockmail

    # Fallback – evita 503 se host não casar com ACL
    default_backend backend_mockmail

############################
# ▶ BACKENDS
############################

# API MockMail – Node.js (porta 3000)
backend backend_mockmail
    mode http
    balance roundrobin
    option forwardfor
    server node_server 127.0.0.1:3000 check inter 2s fall 3 rise 2

# n8n (porta 5678)
backend backend_n8n
    mode http
    balance roundrobin
    option forwardfor
    server n8n1 127.0.0.1:5678 check inter 3s fall 3 rise 2


# Backend para MockMail Dashboard
backend backend_watch_mockmail
    balance roundrobin
    option httpchk GET /api/health
    http-check expect status 200
    timeout check 5s
    server watch1 127.0.0.1:3001 check inter 5s fall 5 rise 2


# Backend para servir arquivos estáticos (.well-known/acme-challenge)
backend backend_webroot
    server webroot1 127.0.0.1:8080 check
