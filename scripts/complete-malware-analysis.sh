#!/bin/bash
# Análise Completa de Malware (sem sudo)

echo "═══════════════════════════════════════════════════════════"
echo "  ANÁLISE PROFUNDA DE MALWARE - $(date)"
echo "═══════════════════════════════════════════════════════════"

# 1. Processos de mineração
echo ""
echo "[1/10] Processos de mineração conhecidos..."
MINERS=$(ps aux | grep -iE "xmrig|xmr-stak|ccminer|ethminer|minerd|cpuminer|stratum|nicehash|monero|coinhive" | grep -v grep)
if [ -z "$MINERS" ]; then
    echo "  ✓ Nenhum minerador conhecido"
else
    echo "  ✗ ALERTA: Mineradores detectados!"
    echo "$MINERS"
fi

# 2. Processos de /tmp
echo ""
echo "[2/10] Processos executando de /tmp ou /var/tmp..."
TMP_PROCS=$(ps aux | awk '$11 ~ /^\/tmp\/|^\/var\/tmp\//')
if [ -z "$TMP_PROCS" ]; then
    echo "  ✓ Nenhum processo em diretórios temporários"
else
    echo "  ⚠ ALERTA:"
    echo "$TMP_PROCS"
fi

# 3. Processos com nomes suspeitos
echo ""
echo "[3/10] Processos com nomes disfarçados de kernel..."
FAKE_KERNEL=$(ps aux | grep -E "^\[.*\]$|mm_percpu|kworker" | grep -v "grep\|PID" | awk '$3 > 5 || $4 > 5')
if [ -z "$FAKE_KERNEL" ]; then
    echo "  ✓ Nenhum processo kernel suspeito"
else
    echo "  ⚠ Processos kernel com alto uso:"
    echo "$FAKE_KERNEL"
fi

# 4. Conexões de rede suspeitas
echo ""
echo "[4/10] Conexões para portas de mineração (3333, 8333, 14444)..."
MINING_CONNS=$(lsof -i -n 2>/dev/null | grep -E ":3333|:8333|:14444|:5555|:7777" | grep -v "127.0.0.1")
if [ -z "$MINING_CONNS" ]; then
    echo "  ✓ Nenhuma conexão para portas de mineração"
else
    echo "  ✗ ALERTA: Conexões suspeitas!"
    echo "$MINING_CONNS"
fi

# 5. Arquivos executáveis suspeitos
echo ""
echo "[5/10] Executáveis em locais incomuns..."
find /dev/shm /tmp /var/tmp -type f -executable 2>/dev/null | while read file; do
    echo "  ⚠ $file"
done
[ $(find /dev/shm /tmp /var/tmp -type f -executable 2>/dev/null | wc -l) -eq 0 ] && echo "  ✓ Nenhum executável suspeito"

# 6. Processos com alta CPU mas não visíveis
echo ""
echo "[6/10] Top 10 processos por CPU..."
ps aux --sort=-%cpu | head -11 | tail -10 | awk '{printf "  %5s %4s%% %4s%% %s\n", $2, $3, $4, $11}'

# 7. Processos com alta memória
echo ""
echo "[7/10] Top 10 processos por memória..."
ps aux --sort=-%mem | head -11 | tail -10 | awk '{printf "  %5s %4s%% %4s%% %s\n", $2, $3, $4, $11}'

# 8. Verificar cron jobs
echo ""
echo "[8/10] Cron jobs do usuário..."
crontab -l 2>/dev/null | grep -v "^#" | grep -v "^$" || echo "  ✓ Nenhum cron job"

# 9. Processos Python/Node sem identificação clara
echo ""
echo "[9/10] Scripts Python/Node ativos..."
ps aux | grep -E "python|node" | grep -v "grep" | awk '{print "  PID:"$2, "CPU:"$3"% MEM:"$4"%", $11, $12, $13}' | head -15

# 10. Arquivos modificados recentemente em home
echo ""
echo "[10/10] Arquivos executáveis modificados nos últimos 7 dias..."
find ~ -type f -executable -mtime -7 2>/dev/null | grep -v ".cache\|.npm\|node_modules\|.pm2\|.vscode" | head -20 | while read file; do
    SIZE=$(stat -c%s "$file" 2>/dev/null)
    MODIFIED=$(stat -c%y "$file" 2>/dev/null | cut -d' ' -f1)
    echo "  $file ($SIZE bytes, $MODIFIED)"
done

echo ""
echo "═══════════════════════════════════════════════════════════"
echo "  ANÁLISE COMPLETA"
echo "═══════════════════════════════════════════════════════════"
