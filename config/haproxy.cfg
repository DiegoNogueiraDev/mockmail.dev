#######################################################################
# /etc/haproxy/haproxy.cfg – MockMail.dev (Homologação + Produção)
# Última edição : 01 fev 2026
#######################################################################

############################
# ▶ GLOBAL
############################
global
    log /dev/log local0 info
    log /dev/log local1 notice
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin
    stats timeout 30s
    user  haproxy
    group haproxy
    daemon

    # Proteção contra ataques DDoS
    maxconn 4096                      # nº máx. de conexões simultâneas

############################
# ▶ DEFAULTS
############################
defaults
    log     global
    mode    http
    option  httplog
    timeout connect 5s
    timeout client  50s
    timeout server  50s
    maxconn 5000

    # Health-check & redispatch
    retries 3
    option  redispatch

############################
# ▶ FRONTENDS
############################

# ── HTTP :80 ➜ redireciona para HTTPS
frontend http_in
    bind *:80
    mode http
    # ACME challenge exception
    acl is_acme_challenge path_beg /.well-known/acme-challenge/
    use_backend backend_webroot if is_acme_challenge
    # Redirect to HTTPS except for ACME challenges
    redirect scheme https code 301 if !{ ssl_fc } !is_acme_challenge

# ── HTTPS :443 com SNI
# Lê todos os .pem em /etc/ssl/haproxy/ e devolve o cert correto
frontend https_in
    bind *:443 ssl crt /etc/ssl/haproxy/ no-sslv3 no-tlsv10 no-tlsv11
    mode http

    # ACLs por domínio - PRODUÇÃO
    acl host_frontend_prod    hdr(host) -i mockmail.dev
    acl host_api_prod         hdr(host) -i api.mockmail.dev

    # ACLs por domínio - HOMOLOGAÇÃO
    acl host_frontend_hml     hdr(host) -i homologacao.mockmail.dev
    acl host_api_hml          hdr(host) -i api.homologacao.mockmail.dev

    # ACME challenge
    acl is_acme_challenge path_beg /.well-known/acme-challenge/

    # Roteamento
    use_backend backend_webroot       if is_acme_challenge
    use_backend backend_api_prod      if host_api_prod
    use_backend backend_frontend_prod if host_frontend_prod
    use_backend backend_api_hml       if host_api_hml
    use_backend backend_frontend_hml  if host_frontend_hml

    # Fallback – produção
    default_backend backend_frontend_prod

############################
# ▶ BACKENDS - PRODUÇÃO
############################

# API MockMail Produção – Node.js (porta 3000)
backend backend_api_prod
    mode http
    balance roundrobin
    option forwardfor
    option httpchk GET /api/health
    http-check expect status 200
    server api_prod_1 127.0.0.1:3000 check inter 2s fall 3 rise 2

# Frontend MockMail Produção – Next.js (porta 3001)
backend backend_frontend_prod
    mode http
    balance roundrobin
    option forwardfor
    option httpchk GET /
    http-check expect status 200
    server frontend_prod_1 127.0.0.1:3001 check inter 5s fall 3 rise 2

############################
# ▶ BACKENDS - HOMOLOGAÇÃO
############################

# API MockMail Homologação – Node.js (porta 3010)
backend backend_api_hml
    mode http
    balance roundrobin
    option forwardfor
    option httpchk GET /api/health
    http-check expect status 200
    server api_hml_1 127.0.0.1:3010 check inter 2s fall 3 rise 2

# Frontend MockMail Homologação – Next.js (porta 3011)
backend backend_frontend_hml
    mode http
    balance roundrobin
    option forwardfor
    option httpchk GET /
    http-check expect status 200,301,302,307
    server frontend_hml_1 127.0.0.1:3011 check inter 5s fall 3 rise 2

############################
# ▶ BACKEND - UTILITÁRIOS
############################

# Backend para servir arquivos estáticos (.well-known/acme-challenge)
backend backend_webroot
    mode http
    server webroot1 127.0.0.1:8080 check
